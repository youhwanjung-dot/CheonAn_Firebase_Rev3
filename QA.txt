// [기존 import 문 생략...]
import { fs, path } from '@tauri-apps/api'; // [활성화]

const App = () => {
    const [isDataLoaded, setIsDataLoaded] = useState(false);
    const [dbVersion, setDbVersion] = useState<string>("1.0"); // [추가: 버전 상태 관리] [cite: 99]
    // ... 기타 상태 변수들 (inventory, transactions, users 등)

    // 1. 데이터 로드 및 지능적 병합 (Migration)
    useEffect(() => {
        const initializeData = async () => {
            try {
                let finalData;

                if (window.__TAURI__) {
                    const DATA_FILE_NAME = 'database.json';
                    const appDataDirPath = await path.appDataDir();
                    if (!(await fs.exists(appDataDirPath))) await fs.createDir(appDataDirPath);
                    const filePath = await path.join(appDataDirPath, DATA_FILE_NAME);

                    // 리소스(새 버전) 파일 읽기
                    const resourcePath = await path.resolveResource(DATA_FILE_NAME);
                    const resourceContent = await fs.readTextFile(resourcePath);
                    const resourceData = JSON.parse(resourceContent);

                    if (await fs.exists(filePath)) {
                        // 사용자 데이터가 있는 경우: 지능적 병합 수행
                        const localContent = await fs.readTextFile(filePath);
                        const localData = JSON.parse(localContent);

                        // [지능적 병합 로직]
                        finalData = {
                            ...localData, // 기존 재고(inventory), 수불(transactions) 보존
                            dbVersion: resourceData.dbVersion, // 버전은 새 것으로 갱신
                            // 기준 정보(Users)는 신규 항목만 추가 (ID 기준 중복 제외)
                            users: [
                                ...localData.users,
                                ...resourceData.users.filter((ru: any) => !localData.users.some((lu: any) => lu.id === ru.id))
                            ]
                        };
                    } else {
                        // 최초 실행 시: 리소스 데이터를 복사하여 시작
                        finalData = resourceData;
                    }
                } else {
                    // Web Preview 환경 로직
                    const response = await fetch(`/database.json?v=${APP_VERSION}`);
                    finalData = await response.json();
                }

                // 앱 상태에 반영
                setInventory(sortInventory(finalData.inventory || []));
                setTransactions(finalData.transactions || []);
                setUsers(finalData.users || []);
                setDbVersion(finalData.dbVersion || "1.0"); // [cite: 101]

            } catch (error) {
                console.error("Initialization Failed:", error);
            } finally {
                setIsDataLoaded(true);
            }
        };

        initializeData();
    }, []);

    // 2. 안전한 데이터 저장 (Save Logic)
    useEffect(() => {
        if (!isDataLoaded || !window.__TAURI__) return;

        const handler = setTimeout(async () => {
            try {
                const appDataDirPath = await path.appDataDir();
                const filePath = await path.join(appDataDirPath, 'database.json');
                
                // 오직 앱 상태(RAM) 정보에만 의존하여 페이로드 구성 
                const payload = {
                    dbVersion, // 보관 중인 버전을 그대로 기록 [cite: 101]
                    inventory,
                    transactions,
                    users
                };

                await fs.writeFile({
                    path: filePath,
                    contents: JSON.stringify(payload, null, 2)
                });
            } catch (error) {
                console.error("Tauri: Failed to save data:", error);
            }
        }, 1000); // Debounce

        return () => clearTimeout(handler);
    }, [inventory, transactions, users, dbVersion, isDataLoaded]);

    // [이후 UI 렌더링 로직 생략...]
};